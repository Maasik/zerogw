

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Zerogw Backend Protocols &mdash; Zerogw v0.5.9 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.5.9',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Zerogw v0.5.9 documentation" href="index.html" />
    <link rel="next" title="Control Socket Protocol" href="control.html" />
    <link rel="prev" title="Installation Guide" href="install.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="control.html" title="Control Socket Protocol"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation Guide"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Zerogw v0.5.9 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="zerogw-backend-protocols">
<h1>Zerogw Backend Protocols<a class="headerlink" href="#zerogw-backend-protocols" title="Permalink to this headline">¶</a></h1>
<div class="section" id="http-forwarding">
<h2>HTTP Forwarding<a class="headerlink" href="#http-forwarding" title="Permalink to this headline">¶</a></h2>
<p>We use zeromq&#8217;s request reply model for http forwarding (except for
<a class="reference internal" href="#long-polling"><em>long polling case</em></a>)</p>
<div class="section" id="request">
<h3>Request<a class="headerlink" href="#request" title="Permalink to this headline">¶</a></h3>
<p>For each http request zerogw forwards a single multipart message.
Request_id is sent like address data (message parts that can be read
using XREP sockets only, and finished by empty message). After address
data configured parts of the request are sent one by one as multipart
message. E.g. if you have following in configuration:</p>
<div class="highlight-python"><pre>zmq-forward:
  contents:
    - !Method
    - !Uri
    - !Header Cookie
    - !Body</pre>
</div>
<p>And you&#8217;ve got request:</p>
<div class="highlight-python"><pre>POST /hello HTTP/1.1
Host: example.com
Cookie: example=cookie_value
Content-Length: 8

PostBody</pre>
</div>
<p>You will receive following message parts (one line per message part):</p>
<div class="highlight-python"><pre>POST
/hello
example=cookie_value
PostBody</pre>
</div>
<p>It&#8217;s up to the application for how to act upon it. Note if you set
<tt class="docutils literal"><span class="pre">retry</span></tt> to something you can get same request twice. And if <tt class="docutils literal"><span class="pre">retry</span></tt>
is set to <tt class="docutils literal"><span class="pre">!RetryFirst</span> <span class="pre">&lt;N&gt;</span></tt> request id will be same for every attempt,
if you&#8217;ve set <tt class="docutils literal"><span class="pre">retry</span></tt> to <tt class="docutils literal"><span class="pre">!RetryLast</span> <span class="pre">&lt;N&gt;</span></tt> request id will change on
each attempt. But usually request id is opaque for user in zeromq.</p>
</div>
<div class="section" id="response">
<h3>Response<a class="headerlink" href="#response" title="Permalink to this headline">¶</a></h3>
<p>Response can contain one, two or three parts for convenience.</p>
<p>In the simple case you just send message body, as a single part message.
Zerogw will respond with <tt class="docutils literal"><span class="pre">200</span> <span class="pre">OK</span></tt> and that message body.</p>
<p>If you respond with two messages first one will be status line, so yo
can respond with 404 page like the following:</p>
<div class="highlight-python"><pre>404 Not Found
&lt;h1&gt; Page Not Found&lt;/h1&gt;</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">These ways are quite unuseful in real situations.
<tt class="docutils literal"><span class="pre">Content-Length</span></tt> header will be added automatically, but you should
configure specific <tt class="docutils literal"><span class="pre">Content-Type</span></tt> header in a config to be sure
that browser will render page correctly when using this method</p>
</div>
<p>If you need to supply headers you send 3 message parts. Second one is
constructed from nul-terminated name/value header pairs:</p>
<div class="highlight-python"><pre>200 OK
Content-Type\0text/html\0E-tag\0immortal\0
&lt;b&gt;Lorem ipsum dolor sit amet&lt;/b&gt;</pre>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Last header value must be nul-terminated. You must not add
<tt class="docutils literal"><span class="pre">Content-Length</span></tt> header as it will be generated automatically.
Currently headers sent from backend will be appended to headers
specified in config without overwriting, it can lead to unexpected
behavior on some proxies or browsers so you should use use one or
another way for each header type throught the whole application.</p>
</div>
</div>
</div>
<div class="section" id="websockets-backend-protocol">
<span id="long-polling"></span><h2>WebSockets Backend Protocol<a class="headerlink" href="#websockets-backend-protocol" title="Permalink to this headline">¶</a></h2>
<p>Zerogw implements unified interface for application writers for both
long polling and websockets. Both are used for bidirectional message
channels from client to server.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is no overhead of using long polling with normal http
backend in zerogw if that suits your application. This interface is
provided to make using either websockets or long polling transparent
for both frontend and backend developer and provides reliable message
stream.</p>
</div>
<div class="section" id="zerogw-to-backend-messages">
<h3>Zerogw to Backend Messages<a class="headerlink" href="#zerogw-to-backend-messages" title="Permalink to this headline">¶</a></h3>
<p>Most messages from server to client consists of client id (long binary
string of nonsense) and ascii command name, following more message parts
which we will call arguments in the text below.</p>
<div class="section" id="connection-messages">
<h4>Connection Messages<a class="headerlink" href="#connection-messages" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">connect</span></tt></dt>
<dd>is sent when new connection established, no arguments</dd>
<dt><tt class="docutils literal"><span class="pre">disconnect</span></tt></dt>
<dd><p class="first">is sent when connection disconnected. All subscriptions
(see below) are already cancelled so you don&#8217;t need to remove them,
but you can cleanup some application-specific data. No arguments</p>
<p class="last">Starting with v0.5.10: disconnect appends an cookie (see below)
as an argument, if cookie is set (it breaks compatibility somewhat
with versions starting with v0.5.8, which did not return cookie
on the disconnect)</p>
</dd>
</dl>
</div>
<div class="section" id="messages">
<h4>Messages<a class="headerlink" href="#messages" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt><tt class="docutils literal"><span class="pre">message</span></tt></dt>
<dd>message sent from frontend to websocket, has single
argument - message text. Can be binary if the browser (or malicious
client) sent binary data</dd>
<dt><tt class="docutils literal"><span class="pre">msgfrom</span></tt></dt>
<dd>message sent from frontend to websocket, has two arguments <em>cookie</em>
and <em>message text</em>, latter is same as in <tt class="docutils literal"><span class="pre">message</span></tt> and former is
an opaque string set by <tt class="docutils literal"><span class="pre">set_cookie</span></tt> (see below)</dd>
</dl>
</div>
<div class="section" id="heartbeats">
<h4>Heartbeats<a class="headerlink" href="#heartbeats" title="Permalink to this headline">¶</a></h4>
<p>There are two kinds of heartbeat messages:</p>
<ul class="simple">
<li>plain heartbeat, activated by <tt class="docutils literal"><span class="pre">heartbeat-interval</span></tt> setting</li>
<li>synchronisation message containing connection ids, activated by
<tt class="docutils literal"><span class="pre">sync-interval</span></tt> setting</li>
</ul>
<p>Both start with <tt class="docutils literal"><span class="pre">server</span> <span class="pre">id</span></tt> message. For the former server id is followed by
literal ascii <tt class="docutils literal"><span class="pre">heartbeat</span></tt>. Latter consists of literal ascii <tt class="docutils literal"><span class="pre">sync</span></tt> followed
by pairs connection_id, cookie (latter is empty if cookie is not sent, but is
always sent).</p>
<p>Sync messages are only sent to named outputs (see below), and can be used to
synchronize user list with backend in case of network failures (<tt class="docutils literal"><span class="pre">connect</span></tt> or
<tt class="docutils literal"><span class="pre">disconnect</span></tt> message lost), backend failures (could not process <tt class="docutils literal"><span class="pre">connect</span></tt>
or <tt class="docutils literal"><span class="pre">disconnect</span></tt> message, because backend crashed when processing message) or
zerogw crashes (zerogw can&#8217;t send <tt class="docutils literal"><span class="pre">disconnect</span></tt> messages after restart).</p>
</div>
</div>
<div class="section" id="backend-to-zerogw-messages">
<h3>Backend to Zerogw Messages<a class="headerlink" href="#backend-to-zerogw-messages" title="Permalink to this headline">¶</a></h3>
<p>Usually messages sent from backend are published using pubsub to several
zerogw. This allows not to track where user currently is and also allows
to publish messages to several users without doing that on backend.</p>
<div class="section" id="direct-messages">
<h4>Direct Messages<a class="headerlink" href="#direct-messages" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt><tt class="samp docutils literal"><span class="pre">send,</span> <em><span class="pre">conn_id</span></em><span class="pre">,</span> <em><span class="pre">message</span></em></tt></dt>
<dd>sends message directly to the user.  You can send binary message,
but most browsers can read only text data, so use utf-8</dd>
<dt><tt class="samp docutils literal"><span class="pre">sendall,</span> <em><span class="pre">message</span></em></tt></dt>
<dd>sends message to all connections. Of course addressees are limited to a
single route, not to the whole zerogw. Note that message is also sent to
unauthenticated connections. You need to subscribe all users to some topic
and use <tt class="docutils literal"><span class="pre">publish</span></tt> if you want to send to authenticated users only.</dd>
</dl>
</div>
<div class="section" id="topic-subscription">
<h4>Topic Subscription<a class="headerlink" href="#topic-subscription" title="Permalink to this headline">¶</a></h4>
<p>Topics is a mechanism in zerogw which allows you to send message to
several users effeciently. You first subscribe users to a topic, send
publish a message to a topic, and all users get this message. Topic is
an opaque binary string. Topics are created and removed on demand and
are quite fast to use them for a lot of things.</p>
<dl class="docutils">
<dt><tt class="samp docutils literal"><span class="pre">subscribe,</span> <em><span class="pre">conn_id</span></em><span class="pre">,</span> <em><span class="pre">topic</span></em></tt></dt>
<dd>subscribes user</dd>
<dt><tt class="samp docutils literal"><span class="pre">unsubscribe,</span> <em><span class="pre">conn_id</span></em><span class="pre">,</span> <em><span class="pre">topic</span></em></tt></dt>
<dd>unsubscribes user</dd>
<dt><tt class="samp docutils literal"><span class="pre">publish,</span> <em><span class="pre">topic</span></em><span class="pre">,</span> <em><span class="pre">message</span></em></tt></dt>
<dd>publish message to a topic, message will be delivered to all users
subscribed on the topic</dd>
<dt><tt class="samp docutils literal"><span class="pre">drop,</span> <em><span class="pre">topic</span></em></tt></dt>
<dd>delete topic, unsubscribing all the users</dd>
</dl>
</div>
<div class="section" id="outputs">
<h4>Outputs<a class="headerlink" href="#outputs" title="Permalink to this headline">¶</a></h4>
<p>In addition to subscription clients on topics you can subscribe subset
of client messages to a specific named backend (<tt class="docutils literal"><span class="pre">named-outputs</span></tt> in
config)</p>
<dl class="docutils">
<dt><tt class="samp docutils literal"><span class="pre">add_output,</span> <em><span class="pre">conn_id</span></em><span class="pre">,</span> <em><span class="pre">msg_prefix</span></em><span class="pre">,</span> <em><span class="pre">name</span></em></tt></dt>
<dd>map prefix to specific output</dd>
<dt><tt class="samp docutils literal"><span class="pre">del_output,</span> <em><span class="pre">conn_id</span></em><span class="pre">,</span> <em><span class="pre">msg_prefix</span></em></tt></dt>
<dd>unmap prefix</dd>
</dl>
<p>As with subscriptions don&#8217;t need to unmap anything from disconnected
user.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">it&#8217;s your responsibility to clean user state from the backend.
<tt class="docutils literal"><span class="pre">disconnect</span></tt> messages are sent to main backend only</p>
</div>
</div>
<div class="section" id="cookie">
<h4>Cookie<a class="headerlink" href="#cookie" title="Permalink to this headline">¶</a></h4>
<p>Cookie is a experimental feature of zerogw v0.5.8, which allows to
prepend opaque data to all messages sent from a client. This is usually
used to authorize connection without need to access authorization
database on each user&#8217;s message. Only one cookie can be attached at a
time, but you can change the cookie at any time. Once set, you can&#8217;t
discard cookie. Once cookie attached all messages will be forwarded
using <tt class="docutils literal"><span class="pre">msgfrom</span></tt> message type with cookie and data.</p>
<dl class="docutils">
<dt><tt class="samp docutils literal"><span class="pre">set_cookie,</span> <em><span class="pre">conn_id</span></em><span class="pre">,</span> <em><span class="pre">cookie</span></em></tt></dt>
<dd>set cookie for the connection, cookie is an opaque string</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">starting with v0.5.10 cookie set with <tt class="docutils literal"><span class="pre">set_cookie</span></tt> are
sent in <tt class="docutils literal"><span class="pre">disconnect</span></tt> messages. Since disconnect can occur before
you were able to set cookie you must tolerate different number of
arguments in <tt class="docutils literal"><span class="pre">disconnect</span></tt> messsages.</p>
</div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Zerogw Backend Protocols</a><ul>
<li><a class="reference internal" href="#http-forwarding">HTTP Forwarding</a><ul>
<li><a class="reference internal" href="#request">Request</a></li>
<li><a class="reference internal" href="#response">Response</a></li>
</ul>
</li>
<li><a class="reference internal" href="#websockets-backend-protocol">WebSockets Backend Protocol</a><ul>
<li><a class="reference internal" href="#zerogw-to-backend-messages">Zerogw to Backend Messages</a><ul>
<li><a class="reference internal" href="#connection-messages">Connection Messages</a></li>
<li><a class="reference internal" href="#messages">Messages</a></li>
<li><a class="reference internal" href="#heartbeats">Heartbeats</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backend-to-zerogw-messages">Backend to Zerogw Messages</a><ul>
<li><a class="reference internal" href="#direct-messages">Direct Messages</a></li>
<li><a class="reference internal" href="#topic-subscription">Topic Subscription</a></li>
<li><a class="reference internal" href="#outputs">Outputs</a></li>
<li><a class="reference internal" href="#cookie">Cookie</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="install.html"
                        title="previous chapter">Installation Guide</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="control.html"
                        title="next chapter">Control Socket Protocol</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/proto.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="control.html" title="Control Socket Protocol"
             >next</a> |</li>
        <li class="right" >
          <a href="install.html" title="Installation Guide"
             >previous</a> |</li>
        <li><a href="index.html">Zerogw v0.5.9 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Paul Colomiets.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.8.
    </div>
  </body>
</html>